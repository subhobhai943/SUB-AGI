name: SUB-AGI Runner

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      run_mode:
        description: 'Run mode'
        required: true
        default: 'interactive'
        type: choice
        options:
        - interactive
        - environment_test
        - mind_kernel_test

jobs:
  run-sub-agi:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Add any dependencies here when needed
        # pip install -r requirements.txt
        
    - name: Run SUB-AGI Interactive
      if: github.event.inputs.run_mode == 'interactive' || github.event.inputs.run_mode == ''
      run: |
        echo "=== SUB-AGI Mind Kernel Test ==="
        python -c "
        from src.mind_kernel.core import MindKernel
        
        print('Initializing SUB-AGI...')
        kernel = MindKernel()
        
        test_inputs = ['A', 'B', 'Hello', 'C']
        for inp in test_inputs:
            print(f'\nYou: {inp}')
            reply, state = kernel.step(inp)
            print(f'SUB-AGI: {reply}')
            print(f'Tick: {state.meta.tick}')
        
        print('\n=== Final Mind State ===')
        print(f'Identity: {kernel.state.identity.name}')
        print(f'Development stage: {kernel.state.identity.development_stage}')
        print(f'Total ticks: {kernel.state.meta.tick}')
        print(f'Letters seen: {kernel.state.perception.alphabet_focus.letters_seen}')
        "
        
    - name: Run Environment Test
      if: github.event.inputs.run_mode == 'environment_test'
      run: |
        echo "=== SUB-AGI GridWorld Environment Test ==="
        python -c "
        from src.environment.grid_world import GridWorld
        
        print('Creating GridWorld environment...')
        env = GridWorld()
        
        print('\nInitial state:')
        obs = env.reset()
        print(env.grid_as_str())
        print(f'Agent position: {obs.agent_position}')
        print(f'Visible objects: {len(obs.visible_objects)}')
        
        actions = ['right', 'down', 'left', 'up', 'stay']
        for action in actions:
            print(f'\n--- Action: {action} ---')
            obs, reward, done, info = env.step(action)
            print(env.grid_as_str())
            print(f'Agent position: {obs.agent_position}')
        
        print('\n=== Environment Test Complete ===')
        print(f'Final agent position: {obs.agent_position}')
        print(f'Objects in world: {[obj.id for obj in env.objects]}')
        "
        
    - name: Run Mind Kernel Test
      if: github.event.inputs.run_mode == 'mind_kernel_test'
      run: |
        echo "=== SUB-AGI Mind Kernel Deep Test ==="
        python -c "
        from src.mind_kernel.core import MindKernel
        from src.mind_kernel.mind_state import MindState
        
        print('Testing MindState creation and serialization...')
        state = MindState.new()
        state_dict = state.to_dict()
        
        print(f'Initial state keys: {list(state_dict.keys())}')
        print(f'Identity: {state.identity.name}')
        print(f'Development stage: {state.identity.development_stage}')
        print(f'Initial tick: {state.meta.tick}')
        
        kernel = MindKernel()
        test_cases = [
            'A',
            'This is the letter B',
            'C',
            'What is my name?'
        ]
        
        for i, inp in enumerate(test_cases, 1):
            print(f'\n--- Test {i}: {inp} ---')
            reply, new_state = kernel.step(inp)
            print(f'Reply: {reply}')
            print(f'Tick: {new_state.meta.tick}')
            print(f'Thoughts: {len(new_state.working_memory.current_thoughts)}')
            print(f'Episodic events: {len(new_state.long_term_memory.episodic[0].events) if new_state.long_term_memory.episodic else 0}')
        
        print('\n=== Mind Kernel Test Complete ===')
        print(f'Final letters seen: {kernel.state.perception.alphabet_focus.letters_seen}')
        print(f'Final development stage: {kernel.state.identity.development_stage}')
        "
        
    - name: Save test results
      if: always()
      run: |
        echo "Test completed at $(date)" >> test_results.log
        echo "Workflow run: ${{ github.run_id }}" >> test_results.log
        echo "Repository: ${{ github.repository }}" >> test_results.log
        
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: sub-agi-test-results-${{ github.run_id }}
        path: test_results.log
        retention-days: 30
        
    - name: Create issue on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `SUB-AGI Workflow Failed: Run #${{ github.run_id }}`,
            body: `The SUB-AGI GitHub workflow failed. 
            
            **Run ID**: ${{ github.run_id }}
            **Commit**: ${{ github.sha }}
            **Workflow**: ${{ github.workflow }}
            
            Please check the logs and fix any issues.
            
            [View run details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
          })