name: SUB-AGI Runner

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      run_mode:
        description: 'Run mode'
        required: true
        default: 'interactive'
        type: choice
        options:
        - interactive
        - environment_test
        - mind_kernel_test
        - phase1_test
        - phase2_test

jobs:
  run-sub-agi:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # pip install -r requirements.txt
        
    - name: Run SUB-AGI Interactive
      if: github.event.inputs.run_mode == 'interactive' || github.event.inputs.run_mode == ''
      run: |
        echo "=== SUB-AGI Mind Kernel Test ==="
        python -c "
        from src.mind_kernel.core import MindKernel
        print('Initializing SUB-AGI...')
        kernel = MindKernel()
        test_inputs = ['A', 'B', 'Hello', 'C']
        for inp in test_inputs:
            print(f'\nYou: {inp}')
            reply, state = kernel.step(inp)
            print(f'SUB-AGI: {reply}')
        " 2> error.log
        
    - name: Run Environment Test
      if: github.event.inputs.run_mode == 'environment_test'
      run: |
        echo "=== SUB-AGI GridWorld Environment Test ==="
        python -c "
        from src.environment.grid_world import GridWorld
        env = GridWorld()
        env.reset()
        print('GridWorld created successfully.')
        " 2> error.log
        
    - name: Run Mind Kernel Test
      if: github.event.inputs.run_mode == 'mind_kernel_test'
      run: |
        echo "=== SUB-AGI Mind Kernel Deep Test ==="
        python -c "
        from src.mind_kernel.core import MindKernel
        kernel = MindKernel()
        kernel.step('Test')
        print('Kernel step successful.')
        " 2> error.log

    - name: Run Phase 1 Symbol Grounding
      if: github.event.inputs.run_mode == 'phase1_test'
      run: |
        echo "=== Phase 1: Symbol Grounding Experiment ==="
        python src/experiments/phase1_grounding.py 2> error.log

    - name: Run Phase 2 Curiosity Exploration
      if: github.event.inputs.run_mode == 'phase2_test'
      run: |
        echo "=== Phase 2: Curiosity & Exploration Experiment ==="
        python src/experiments/phase2_curiosity.py 2> error.log
        
    - name: Capture Failure Log
      if: failure()
      id: capture_log
      run: |
        echo "Reading error log..."
        if [ -f error.log ]; then
          ERROR_CONTENT=$(cat error.log | tail -n 20)
          echo "error_log<<EOF" >> $GITHUB_ENV
          echo "$ERROR_CONTENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        else
          echo "error_log=No error log found." >> $GITHUB_ENV
        fi

    - name: Create issue on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const errorLog = process.env.error_log;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `⚠️ Workflow Failed: Run #${{ github.run_id }}`,
            body: `The SUB-AGI GitHub workflow failed during **${{ github.event.inputs.run_mode || 'default run' }}**.
            
            ### Failure Reason
            \`\`\`text
            ${errorLog}
            \`\`\`
            
            **Run Details**:
            - **Run ID**: ${{ github.run_id }}
            - **Commit**: ${{ github.sha }}
            - **Actor**: ${{ github.actor }}
            
            [View full logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
          })
